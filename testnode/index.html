<!doctype html>
<!-- [ Power By Dannegm (c) 2012 - http://dannegm.com ] -->
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Super chat</title>
	<link rel="stylesheet/less" href="estilo.less" />

	<!-- Incluimos la librería de socket.io -->
	<script src="http://adsearch.mx:6546/socket.io/socket.io.js"></script>
	<!-- jQuery por es algo muy necesario -->
	<script src="js/jquery.min.js"></script>
	<script src="less.min.js"></script>
	<script src="dannegm.dialogs.js"></script>
	<script>

	// Antes de iniciar el chat pedimos que nos de su nombre
	var n = prompt("Tu nombre", "Tu nombre");

	//Cargamos sonidito
	var sonidito = document.createElement('audio');
		sonidito.src = "http://soundjax.com/reddo/27947%5EBells.mp3";
		//sonidito.src = "nokia.mp3";

	//Comprobamos si la ventana esta en foco
	var winFocus = 'si';

	//No esta en foco
	window.onblur = function () {
		winFocus = 'no';
	};

	//Si esta en foco
	window.onfocus = function () {
		winFocus = 'si';
	};
	//Si nos da su nombre continuamos
	if (n){

		// Creamos el socket al servidor
		var socket = io.connect('http://adsearch.mx:6546');

		// Le decimos al servidor que ya entramos, le mandamos nuestro nombre
		socket.emit('entro', n);

		// Esto cuando alguien mas nos manda un mensaje
		socket.on('enviando', function(e){
				// Nos regresa un callback con un objeto json
				var user = e;

				// Esto es para los comandos
				var comando = user.texto.split('::');
				switch(comando[0]){

					// Envia una alerta
					// $alert::foo bar
					case '$alert':
						$alert(comando[1], user.nombre + ' dice:');
						user.texto = comando[1];
						break;

					// Enviar sonidito
					// $sonidito::
					case '$sonidito':
						sonidito.play();
						user.texto = 'soniditooo! :D';
						break;
					// Nos redircciona a otra pag
					// $redir::http://foo.bar
					case '$redir':
						window.location.href = comando[1];
						user.texto = "";
						break;
					// Recarga la pag
					// $reload::
					case '$reload':
						window.location.reload();
						break;
					// Cambiamos el nombre
					// $rename::nuevonomre
					case '$rename':
						n = comando[1];
						user.nombre = n;
						user.texto = "Me he cambiado el nombre";
						break;
					// Texto que camina
					// $marquee::texto
					case '$marquee':
						user.texto = '<marquee>' + comando[1]; + '</marquee>';
						break;
					// Insertar imagen
					// $img::path/to/img
					case '$img':
						user.texto = '<img src="' + comando[1] + '" style="width: 450px;" />';
						break;
					// Iserta video de youtube
					// $youtube::iddelvideo
					case '$youtube':
						user.texto = '<iframe width="350" height="200" src="http://www.youtube.com/embed/' + comando[1] + '" frameborder="0" allowfullscreen></iframe>';
						break;
					// Limpia el historial
					// $clear::
					case '$clear':
						$('#logs').html('');
						$('#logs').append('<p><em style="color: #00c150;"><strong>' + user.nombre + '</strong> ha limpiado el chat</em></p>');
						user.texto = "Me gusta limpio :)";
						break;
				}

				// Añadimos el objeto recibido a la capa #logs donde mostraremos el chat
				$('#logs').append('<p><strong>' + user.nombre + ':</strong> ' + user.texto + '</p>');

				// Esto hace un scroll automatico
				var altodiv = $('#logs').height();
				$('#contenedor').scrollTop( altodiv );

				// Manda sonidito si no estas poniendo atencion
				if (winFocus == 'no'){
					sonidito.play();
					//document.title = user.nombre + ' está hablando';
				}
		});

		// Revisamos si alguien acaba de entrar
		socket.on('entro', function(user){
				$('#logs').append('<p><em style="color: #00c150;"><strong>' + user.nombre + '</strong> acaba de entrar</em></p>');
				var altodiv = $('#logs').height();
				$('#contenedor').scrollTop( altodiv );
		});

		// Revisamos si alguien salió
		socket.on('salio', function(user){
				$('#logs').append('<p><em style="color: #e51414;"><strong>' + user + '</strong> acaba de salir</em></p>');
				var altodiv = $('#logs').height();
				$('#contenedor').scrollTop( altodiv );
		});

		// Usuarios conectados
		socket.on('online', function(user) {
			$('#online').html('');
			$.each(user, function(key, value) {
				$('#online').append('<p>' + value.nombre  + '</p>');
			});
		});

		// vemos si esta escribiendo otro
		socket.on('escribiendo', function(res){
			if ( res.writing == 'si'){
				$('#action').html('<strong>' + res.user + '</strong> está escribiendo...');
			}else{
				$('#action').html('');
			}
		});

		// Funcion que enia el texto al servidor
		function enviar (e) {
			var texto = $('#mensaje').val();

			// Creamos el objeto que vamos a enviar
			var user = {
				nombre: n,
				texto: texto
			}
			$('#mensaje').val('');
			$('#action').html('');

			// Enviamos el objeto
			socket.emit('enviar', user);
		}

		// Iniciamos la aplicación
		function run () {

			// Al enviar el formulario ejecutamos la funcion enviar();
			$('#formulario').submit(function(e){
				e.preventDefault();
				enviar();
			});

			// Si pulsamos enter enviamos el formulario
			$('#mensaje').keyup(function(e){
				var enter = e.keyCode;
				if (enter == '13'){
					$('#formulario').trigger('submit');
				}
			});

			// Vemos si está escribiendo
			$('#mensaje').keydown(function(e){
				var writing = 'no';
				if ($('#mensaje').val() != "") {
					writing = 'si';
				}
				var who = {
					user: n,
					writing: writing
				}
				socket.emit('escribiendo', who);
			});
		}

		// Corremos la aplicacion
		$(document).ready(run);
	}
	</script>
</head>
<body>
	<div id="body">
		<h1>Super chat</h1>
		<div>

			<!-- Aqui ponemos el historial del chat -->
			<section id="contenedor">
				<section id="logs"></section>
			</section>
			<aside id="online">
			</aside>
		</div>

		<!-- aqui escribimos el texto a enviar -->
		<form id="formulario">
			<label id="action"></label>
			<textarea id="mensaje" class="grande"></textarea>
		</form>
	</div>
</body>
</html>